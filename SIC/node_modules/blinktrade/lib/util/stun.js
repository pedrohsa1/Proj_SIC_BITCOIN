'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _slicedToArray = function () { function sliceIterator(arr, i) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"]) _i["return"](); } finally { if (_d) throw _e; } } return _arr; } return function (arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { return sliceIterator(arr, i); } else { throw new TypeError("Invalid attempt to destructure non-iterable instance"); } }; }(); /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * BlinkTradeJS SDK
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * (c) 2016-present BlinkTrade, Inc.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * This file is part of BlinkTradeJS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * This program is free software: you can redistribute it and/or modify
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * it under the terms of the GNU General Public License as published by
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * the Free Software Foundation, either version 3 of the License, or
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * (at your option) any later version.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * This program is distributed in the hope that it will be useful,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * but WITHOUT ANY WARRANTY; without even the implied warranty of
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * GNU General Public License for more details.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * You should have received a copy of the GNU General Public License
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          * along with this program.  If not, see <http://www.gnu.org/licenses/>.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          */

/* eslint-disable no-param-reassign */
/* eslint-disable no-plusplus */
/* eslint-disable import/prefer-default-export */
/* eslint-disable no-restricted-properties */
/* eslint-disable no-buffer-constructor */

exports.getStun = getStun;

var _ip = require('ip');

var _ip2 = _interopRequireDefault(_ip);

var _dgram = require('dgram');

var _dgram2 = _interopRequireDefault(_dgram);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var stunIp = { local: null, public: [] };

function addIPAddress(ipAddress) {
  if (ipAddress.match(/^(192\.168\.|169\.254\.|10\.|172\.(1[6-9]|2\d|3[01]))/)) {
    stunIp.local = ipAddress;
  } else if (stunIp.public.indexOf(ipAddress) === -1) {
    stunIp.public.push(ipAddress);
  }
}

function getStun(callback) {
  var socket = _dgram2.default.createSocket('udp4');

  var STUN_HEADER_LENGTH = 20;
  var stunRequest = new Buffer(STUN_HEADER_LENGTH);

  var STUN_METHOD_REQUEST = 0x000;
  var STUN_BINDING_CLASS = 0x0001;
  var STUN_MAGIC_COOKIE = 0x2112A442;
  var STUN_TID_MAX = Math.pow(2, 32);

  var STUN_ATTR_MAPPED_ADDRESS = 0x0001;
  var STUN_ATTR_XOR_MAPPED_ADDRESS = 0x8020;
  var STUN_ATTR_XOR_MAPPED_ADDRESS_ALT = 0x0020;

  var stunTxId = Math.random() * STUN_TID_MAX;

  var stunServers = [[3478, 'stun.services.mozilla.com'], [19302, 'stun.l.google.com'], [3478, 'stun.stunprotocol.org'], [3478, 'stun.softjoys.com'], [3478, 'stun.samsungsmartcam.com'], [3478, 'stun.sonetel.com'], [3478, 'stun.tagan.ru'], [3478, 'stun.voipgain.com'], [3478, 'stunserver.org'], [3478, 'stun.advfn.com'], [3478, 'stun.annatel.net'], [3478, 'stun.freevoipdeal.com']];

  stunRequest.writeUInt16BE((STUN_BINDING_CLASS | STUN_METHOD_REQUEST) & 0x3fff, 0);
  stunRequest.writeUInt16BE(0, 2);
  stunRequest.writeUInt32BE(STUN_MAGIC_COOKIE, 4);
  stunRequest.writeUInt32BE(0, 8);
  stunRequest.writeUInt32BE(0, 12);
  stunRequest.writeUInt32BE(stunTxId, 16);

  socket.on('message', function (msg) {
    var xor = function xor(a, b) {
      var data = [];
      if (b.length > a.length) {
        var tmp = a;
        a = b;
        b = tmp;
      }
      for (var i = 0, len = a.length; i < len; i++) {
        data.push(a[i] ^ b[i]);
      }

      return new Buffer(data);
    };

    var block = msg.readUInt8(0);
    var bit1 = block & 0x80;
    var bit2 = block & 0x40;

    if (!(bit1 === 0 && bit2 === 0)) {
      return;
    }

    var msgHeader = msg.slice(0, STUN_HEADER_LENGTH);
    var msgAttrs = msg.slice(STUN_HEADER_LENGTH, msg.length);

    var offset = 0;

    while (offset < msgAttrs.length) {
      var attrType = msgAttrs.readUInt16BE(offset);
      offset += 2;

      var attrBuffLength = msgAttrs.readUInt16BE(offset);
      var blockOut = attrBuffLength % 4;
      if (blockOut > 0) {
        attrBuffLength += 4 - blockOut;
      }
      offset += 2;

      var value = msgAttrs.slice(offset, offset + attrBuffLength);
      offset += attrBuffLength;

      var family = void 0;
      var address = void 0;
      switch (attrType) {
        case STUN_ATTR_MAPPED_ADDRESS:
          family = value.readUInt16BE(0) === 0x02 ? 6 : 4;
          address = _ip2.default.toString(value, 4, family);
          addIPAddress(address);
          break;

        case STUN_ATTR_XOR_MAPPED_ADDRESS:
        case STUN_ATTR_XOR_MAPPED_ADDRESS_ALT:
          family = value.readUInt16BE(0) === 0x02 ? 6 : 4;
          var magic = msgHeader.slice(4, 8);
          var tid = msgHeader.slice(8, 20);
          var xaddr = value.slice(4, family === 4 ? 8 : 20);
          var addr = xor(xaddr, family === 4 ? magic : value.concat([magic, tid]));
          address = _ip2.default.toString(addr, 0, family);
          addIPAddress(address);
          break;
        default:
      }
    }

    callback(stunIp);
  });

  stunServers.map(function (_ref) {
    var _ref2 = _slicedToArray(_ref, 2),
        port = _ref2[0],
        host = _ref2[1];

    return socket.send(stunRequest, 0, stunRequest.length, port, host, function () {});
  });
}