'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _sjcl = require('sjcl');

var _sjcl2 = _interopRequireDefault(_sjcl);

var _url = require('url');

var _url2 = _interopRequireDefault(_url);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _baseTransport = require('./baseTransport');

var _baseTransport2 = _interopRequireDefault(_baseTransport);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; } /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * BlinkTradeJS SDK
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * (c) 2016-present BlinkTrade, Inc.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * This file is part of BlinkTradeJS
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * This program is free software: you can redistribute it and/or modify
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * it under the terms of the GNU General Public License as published by
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * the Free Software Foundation, either version 3 of the License, or
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * (at your option) any later version.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * This program is distributed in the hope that it will be useful,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * but WITHOUT ANY WARRANTY; without even the implied warranty of
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * GNU General Public License for more details.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * You should have received a copy of the GNU General Public License
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * along with this program.  If not, see <http://www.gnu.org/licenses/>.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                *
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                * 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                */

var RestTransport = function (_BaseTransport) {
  _inherits(RestTransport, _BaseTransport);

  /**
   * Exchanges currencies available.
   */

  /**
   * APIKey
   */
  function RestTransport(params) {
    _classCallCheck(this, RestTransport);

    var _this = _possibleConstructorReturn(this, (RestTransport.__proto__ || Object.getPrototypeOf(RestTransport)).call(this, params, 'rest'));

    _this.key = params.key;
    _this.secret = params.secret;
    _this.currency = params.currency || 'USD';

    /* eslint-disable indent */
    _this.fetchRequest = _this.isNode ? require('isomorphic-fetch') : _this.isBrowser ? require('fetch-jsonp') : window.fetch;
    /* eslint-enable indent */
    return _this;
  }

  /**
   * Fetch rest API
   */


  /**
   * APISecret
   */


  _createClass(RestTransport, [{
    key: 'headers',
    value: function headers(method, body) {
      var timeStamp = Date.now().toString();
      var hexKey = _sjcl2.default.codec.utf8String.toBits(this.secret);
      var hmac = new _sjcl2.default.misc.hmac(hexKey, _sjcl2.default.hash.sha256);
      var Signature = _sjcl2.default.codec.hex.fromBits(hmac.encrypt(timeStamp));
      return {
        method: method,
        headers: {
          'Content-Type': 'application/json',
          Nonce: timeStamp,
          APIKey: this.key,
          Signature: Signature
        },
        body: JSON.stringify(body)
      };
    }
  }, {
    key: 'fetch',
    value: function fetch(msg, api) {
      var headers = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : {};

      return this.fetchRequest(_url2.default.resolve(this.endpoint, api), headers).then(function (response) {
        return response.json();
      });
    }
  }, {
    key: 'fetchPublic',
    value: function fetchPublic(api) {
      return this.fetch({}, _path2.default.join('api/v1', this.currency, api));
    }
  }, {
    key: 'fetchTrade',
    value: function fetchTrade(msg) {
      var headers = this.headers('POST', msg);
      return this.fetch(msg, 'tapi/v1/message', headers).then(function (response) {
        return response.Status === 500 ? Promise.reject(response) : response.Responses;
      }).then(function (response) {
        return response.length === 1 ? response[0] : response;
      });
    }
  }]);

  return RestTransport;
}(_baseTransport2.default);

exports.default = RestTransport;